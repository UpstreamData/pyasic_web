    <!--
  ~ Copyright 2022 Upstream Data Inc
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

{% macro create_basic_card(card_header, data_name) -%}
<div class="col col-xs-6 col-sm-4 col-md-3 my-2">
        <div class="card text-center">
            <div class="card-header fw-bold">{{ card_header }}</div>
            <div class="card-body hashrate-header d-flex align-items-center h4 p-0 m-0">
                <div class="mx-auto fw-bolder" id="card_{{ data_name }}"></div>
            </div>
        </div>
    </div>
    <script>
        update_ws.addEventListener('message', (event) => {
            {{data_name}}_card = document.getElementById("card_{{data_name}}")
            getAPIData("{{data_name}}", 'all')
                .then(data => {
                    if (data.hasOwnProperty("data")) {
                        var unit = data["data"][Object.keys(data["data"])[0]]["unit"]
                        if (!!{{data_name}}_card) {
                            if (Object.keys(data).length > 0) {
                                const miner_data = data["data"]
                                if (data["combine_method"] == "sum") {
                                    var sum = Object.values(miner_data).reduce((acc, curr) => acc + curr.value, 0);
                                    var total = +sum.toFixed(2)
                                } else if (data["combine_method"] == "avg") {
                                    var sum = Object.values(miner_data).reduce((acc, curr) => acc + curr.value, 0);
                                    var avg = sum / Object.keys(miner_data).length
                                    var total = +avg.toFixed(2)
                                }

                                if (unit == "") {
                                    {{data_name}}_card.innerHTML = total
                                } else {
                                    {{data_name}}_card.innerHTML = total + " " + unit
                                }
                            }
                        }
                    } else {
                        var unit = data["unit"]
                        var val = data["value"]
                        if (!!{{data_name}}_card) {
                            if (unit == "") {
                                {{data_name}}_card.innerHTML = val
                            } else {
                                {{data_name}}_card.innerHTML = val + " " + unit
                            }
                        }
                    }
                })
                .catch(error => console.error(error));
        });
    </script>
{%- endmacro %}
{% macro create_graph_card(card_header, data_name) -%}
<div class="col col-12 col-sm-6 my-2">
    <div class="card">
        <div class="card-header fw-bold text-center">{{ card_header }}</div>
        <div class="card-body">
            <canvas id="card_{{ data_name }}_graph" class="w-100 h-100" style="max-height:187.5px;"></canvas>
        </div>
    </div>
</div>
<script>
const graph_{{ data_name }}_ctx = document.getElementById('card_{{ data_name }}_graph').getContext('2d');
const graph_{{ data_name }}_gradient = graph_{{ data_name }}_ctx.createLinearGradient(0, 0, graph_{{ data_name }}_ctx.canvas.width, 0);
graph_{{ data_name }}_gradient.addColorStop(0, '#D0368A');
graph_{{ data_name }}_gradient.addColorStop(0.99, '#708AD4');
const {{ data_name }}_chart = new Chart(graph_{{ data_name }}_ctx, {
    type: 'line',
    data: {
        datasets: [{
            label: '{{ card_header }}',
            data: [],
            borderColor: function(context) {
                const {{ data_name }}_ctx_chart = context.chart;
                const {ctx, chartArea} = {{ data_name }}_ctx_chart;

                if (!chartArea) {
                    return;
                }
                return getGradient(ctx, chartArea);
            },
            borderWidth: 4, // increase the line width for better visibility
            pointRadius: 2, // set pointRadius to 0 to remove dot points
            fill: true
        }]
    },
    options: {
        animation: false,
        plugins: {
            legend: {
                display: false
            }
        },
        responsive: true,
        scales: {
            x: {
                type: 'time',
                time: {
                    unit: 'minute',
                    max: 30
                }
            },
            y: {
                type: 'linear',
                min: 0,
                ticks: {
                    callback: function(value, index, values) {
                        return value;
                    }
                }
            }
        }
    }
});

update_ws.addEventListener('message', event => {
    getAPIData("{{ data_name }}", 'all')
    .then(data => {
        if (data.hasOwnProperty("data")) {
            const unit = data["data"][Object.keys(data["data"])[0]]["unit"]
            if (Object.keys(data).length > 0) {
                const miner_data = data["data"]
                if (data["combine_method"] == "sum") {
                    var sum = Object.values(miner_data).reduce((acc, curr) => acc + curr.value, 0);
                    var total = +sum.toFixed(2)
                } else if (data["combine_method"] == "avg") {
                    var sum = Object.values(miner_data).reduce((acc, curr) => acc + curr.value, 0);
                    var avg = sum / Object.keys(miner_data).length
                    var total = +avg.toFixed(2)
                }
                {{ data_name }}_chart.data.datasets[0].data.push({ x: new Date(), y: total });
                {{ data_name }}_chart.options.scales.y.ticks.callback = function(value, index, values) {
                    return value + ' ' + unit;
                };
            }
        } else {
            const unit = data["unit"]
            const val = data["value"]
            {{ data_name }}_chart.data.datasets[0].data.push({ x: new Date(), y: val });
            {{ data_name }}_chart.options.scales.y.ticks.callback = function(value, index, values) {
                return value + ' ' + unit;
            };
        }

        // Remove older data points if number of data points exceeds 30
        if ({{ data_name }}_chart.data.datasets[0].data.length > 30) {
            {{ data_name }}_chart.data.datasets[0].data.splice(0, 1);
        }

        {{ data_name }}_chart.update();
    });
});
</script>
{%- endmacro %}

{% macro create_update_ws(request) -%}
    <script>
        if (!window.WebSocket) alert("WebSocket not supported by this browser");
        var update_ws = new WebSocket("ws://{{request.url.hostname}}:{% if request.url.port %}{{request.url.port}}{% else %}80{% endif %}/api/realtime/updates");
    </script>
{%- endmacro %}
