{% extends 'navbar.html'%}
{% block content %}
<nav class="navbar bg-dark" data-bs-theme="dark">
    <div class="row d-flex justify-content-between w-100 align-content-middle">
        <div class="col-7">
            <h2 class="ms-3 mt-1 text-light">
                <svg class="bi me-2 d-none d-sm-inline" width="32" height="32">
                    <use xlink:href="#dashboard"></use>
                </svg>
                Home
            </h2>
        </div>
        <div class="col d-flex justify-content-end">
            <div class="btn-group dropstart">
                <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <svg class="m-0 p-0" style="fill: currentColor; vertical-align: -.25em;" width="20" height="22">
                        <use xlink:href="#action"></use>
                    </svg>
                    Actions
                </button>
                <ul class="dropdown-menu">
                    <!-- <li><a class="dropdown-item" target="_blank" href="http://{{miner}}" role="button">Web Interface</a></li> -->
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                </ul>
            </div>
        </div>
    </div>
</nav>
<div id="py_errors" class="mx-4 m-0 mt-3"></div>
<div class="px-lg-4 my-2 mx-4 mx-lg-0">
    {% if "admin" in user.scopes and cur_miners|length == 0 %}
        <a role="button" href="/scan" id="noMiners" class="w-100 btn btn-info fw-bolder d-flex align-items-center justify-content-center mt-3" style="height:100px;">Click here to add miners.</a>
    {% endif %}
<!--    <div class="row row-cols-1 row-cols-xl-5 row-cols-md-3 my-3 g-3" id="all_cards">-->
    <div class="row" data-masonry='{"percentPosition": true }' id="all_cards">
        {% if not cur_miners|length == 0 %}
            {% for card_name in cards %}
                {% if card_exists('cards/dashboard/' + card_name + '.html') %}
                    {% include 'cards/dashboard/' + card_name + '.html' %}
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
    <script>
        if (!window.WebSocket) alert("WebSocket not supported by this browser");
        var ws = new WebSocket("ws://{{request.url.hostname}}:{% if request.url.port %}{{request.url.port}}{% else %}80{% endif %}/dashboard/ws");
        ws.onmessage = function(event) {
            var data = JSON.parse(event.data)
            errors = document.getElementById("py_errors");
            for (i = 0; i< data["miners"].length; i++) {
                if (data["miners"][i].hasOwnProperty("py_error")) {
                    if (!document.getElementById(data["miners"][i]["ip"] + "_error")) {
                        errors.innerHTML += "<div id='" + data["miners"][i]["ip"] + "_error" +
                        "' class='d-flex align-items-center p-1 mb-1 alert alert-danger'><strong class='p-0 m-0'>" +
                        data["miners"][i]["ip"] + ": " +
                        data["miners"][i]["py_error"] +
                        "</strong><div class='spinner-border spinner-border-sm ms-auto'></div></div>"
                    }
                } else {
                    if (document.getElementById(data["miners"][i]["ip"] + "_error")) {
                        document.getElementById(data["miners"][i]["ip"] + "_error").remove()
                    }
                }
            }
            {% if not cur_miners|length == 0 %}
                {% for card_name in cards %}
                    {% if card_exists('cards/scripts/dashboard/' + card_name + '.js') %}
                        {% include 'cards/scripts/dashboard/' + card_name + '.js' %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        }
    </script>
</div>
{% endblock content %}
